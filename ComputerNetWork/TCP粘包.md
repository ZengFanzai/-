# TCP 粘包

## TCP 和 UDP 的区别

- TCP 基于连接，而 UDP 无连接
- TCP 多系统资源要求更多，而 UDP 要少些
- UDP 结构设计比 TCP 设计简单
- TCP 采用字节流传输而 UDP 使用数据报传输
- TCP 要保证数据报的正确性和顺序性，而 UDP 不需要（可能出现丢包和乱序，但不再重新传输）。

## TCP 与 UDP 的传输区别

在 TCP 中，发送端为了将多个发往接受端的包，更有效的发到对方，使用优化算法(Nagle 算法)：

将多次间隔较小、数据量小的数据，合并成一个大的数据块，然后进行封包传输，所以接收端需要合理的拆包机制。

而 UDP 不会使用合并优化算法，UDP 报头有记录报文长度（消息边界）。

## TCP 粘包出现原因

出现粘包现象的原因是多方面的，它既可能由发送方造成，也可能由接收方造成。

1. 发送方等待缓冲区满才发出去，造成粘包（Nagle 算法）
2. 接收方不及时接受缓冲区的包，造成多个包相连

## 解决办法

通过上层的应用来解决，常见的方式有：

- 在报文末尾增加换行符表明一条完整的消息，这样在接收端可以根据这个换行符来判断消息是否完整。
- 将消息分为消息头、消息体。可以在消息头中声明消息的长度，根据这个长度来获取报文（比如 808 协议）。
- 规定好报文长度，不足的空位补齐，取的时候按照长度截取即可。

## 参考

> - [（经典）tcp 粘包分析](https://blog.csdn.net/zhangxinrun/article/details/6721495)
> - [Netty(三) 什么是 TCP 拆、粘包？如何解决？](https://juejin.im/post/5b67902f6fb9a04fc67c1a24)
