# Redis 数据库持久化

- [Redis 数据库持久化](#redis-%e6%95%b0%e6%8d%ae%e5%ba%93%e6%8c%81%e4%b9%85%e5%8c%96)
  - [Redis 持久化介绍](#redis-%e6%8c%81%e4%b9%85%e5%8c%96%e4%bb%8b%e7%bb%8d)
  - [RDB 和 AOF 介绍](#rdb-%e5%92%8c-aof-%e4%bb%8b%e7%bb%8d)
    - [RDB 的优缺点](#rdb-%e7%9a%84%e4%bc%98%e7%bc%ba%e7%82%b9)
  - [如何选择哪种持久化方式](#%e5%a6%82%e4%bd%95%e9%80%89%e6%8b%a9%e5%93%aa%e7%a7%8d%e6%8c%81%e4%b9%85%e5%8c%96%e6%96%b9%e5%bc%8f)
  - [更多详细信息](#%e6%9b%b4%e5%a4%9a%e8%af%a6%e7%bb%86%e4%bf%a1%e6%81%af)
    - [快照](#%e5%bf%ab%e7%85%a7)
    - [Append-only 文件](#append-only-%e6%96%87%e4%bb%b6)
      - [日志重写](#%e6%97%a5%e5%bf%97%e9%87%8d%e5%86%99)
      - [append-only 文件的耐用性](#append-only-%e6%96%87%e4%bb%b6%e7%9a%84%e8%80%90%e7%94%a8%e6%80%a7)
      - [如果 AOF 被截断怎么办\?](#%e5%a6%82%e6%9e%9c-aof-%e8%a2%ab%e6%88%aa%e6%96%ad%e6%80%8e%e4%b9%88%e5%8a%9e)
      - [如果 AOF 损坏了怎么办\?](#%e5%a6%82%e6%9e%9c-aof-%e6%8d%9f%e5%9d%8f%e4%ba%86%e6%80%8e%e4%b9%88%e5%8a%9e)
      - [如果当前正在使用 dump.rdb 快照如何切换到 AOF\?](#%e5%a6%82%e6%9e%9c%e5%bd%93%e5%89%8d%e6%ad%a3%e5%9c%a8%e4%bd%bf%e7%94%a8-dumprdb-%e5%bf%ab%e7%85%a7%e5%a6%82%e4%bd%95%e5%88%87%e6%8d%a2%e5%88%b0-aof)
      - [AOF 与 RDB 持久化之间的相互作用](#aof-%e4%b8%8e-rdb-%e6%8c%81%e4%b9%85%e5%8c%96%e4%b9%8b%e9%97%b4%e7%9a%84%e7%9b%b8%e4%ba%92%e4%bd%9c%e7%94%a8)
      - [备份 Redis 数据](#%e5%a4%87%e4%bb%bd-redis-%e6%95%b0%e6%8d%ae)
      - [灾难恢复](#%e7%81%be%e9%9a%be%e6%81%a2%e5%a4%8d)

## Redis 持久化介绍

Redis 提供不同的持久性选项：

- RDB 持久化按照指定的时间间隔执行数据集的时间点快照。
- AOF 持久化会记录服务器接收的每个`写操作`，这些操作将在服务器启动时再次执行，以重建原始数据集。其使用与 Redis 协议本身相同的格式记录命令，并且`仅采用追加方式`。当日志太大时，Redis 可以在后台重写日志。
- 如果只需你的数据在服务器运行时存在，则可以完全禁用持久性。
- 在一个实例中可以同时开启 AOF 和 RDB 持久化。在这种情况下，当 Redis 重启时，AOF 文件将用于重建原始数据集，因为它可以保证是最完整的。

## RDB 和 AOF 介绍

### RDB 的优缺点

- RDB 优点
  - RDB 是 Redis 数据的非常紧凑的单文件时间点表示。RDB 文件非常适合备份。例如，你可能希望在最近的 24 小时内每小时存档异常 RDB 文件，并在 30 天之内每天保存一次 RDB 快照。这使你可以在发生灾难时轻松还原数据集的不同版本。
  - RDB 对于灾难恢复非常有用，它是一个紧凑的文件，可以传输到远程数据中心上。
  - RDB 最大限度地提高了 Redis 的性能，因为 Redis 父进程为了持久化所需做的唯一工作就是 fork 一个子进程去做持久化工作。父实例永不会执行磁盘 I/O 或类似操作。
  - 与 AOF 相比，RDB 允许大型数据集更快地重启。
- RDB 缺点
  - 如果你需要在 Redis 停止工作(例如断电后)的情况下最大程度地减少数据丢失，RDB 表现不佳。你可以在生成 RDB 的位置配置不同的保存点(例如，在至少 5 分钟之后，对数据集进行 100 写入，但是你可以有多个保存点)。但是，通常会每隔 5 分钟或更长时间创建一次 RDB 快照，因此，如果 Redis 出于任何原因在没有正确关闭的情况下停止工作，则应该做好丢失最新写入数据的准备。
  - RDB 需要经常使用 fork()才能使用子进程将其持久化在磁盘上。如果数据集很大，那么 fork()可能会很耗时，并且如果数据集很大并且 CPU 性能不是很好，则可能导致 Redis 停止为客户端服务一段时间(几毫秒甚至 1 秒)。AOF 也需要使用 fork()，但是你可以调整重写日志的频率，而无需在耐用性上做权衡。
- AOF 优点
  - 使用 AOF Redis 更加持久：你可以有不同的 fsync 策略：不使用 fsync，每秒 fsync，每个查询 fsync。使用默认策略 fsync 时，每秒的写入性能仍然很好(fsync 是使用后台线程执行的，并且当没有 fsync 进行时，主线程尽力执行写入操作)但是您只能损失一秒钟的写入时间。
  - AOF 日志仅是一个追加日志，因此，如果断电，也不会出现寻道或损坏问题。即使由于某种原因（磁盘已满或其他原因）以半写命令结束日志，redis-check-aof 工具也可以轻松修复它。
  - Redis 太大时，Redis 可以在后台自动重写 AOF。重写是完全安全的，因为 Redis 继续追加到旧文件时，会生成一个全新的文件，其他包含创建当前数据集所需的最少操作集，一旦准备好第二个文件，Redis 会切换这两个文件并开始追加到新的那一个。
  - AOF 以易于理解和解析的格式包含所有操作的日志。你可以轻松导出 AOF 文件。例如，即使你使用 FLUSHALL 命令刷新了所有错误文件，如果在此期间未执行任何日志重写操作，你仍然可以保存数据集，只需停止服务器，删除最新命令并重新启动 Redis。
- AOF 缺点
  - 对于相同的数据集，AOF 文件通常大于等效的 RDB 文件。
  - 根据确切的 fsync 策略，AOF 可能比 RDB 慢。通常，在将 fsync 设置为每秒的情况下，性能仍然很高，并且在禁用 fsync 的情况下，即使在高负载下，它也应与 RDB 一样快。即使在巨大的写负载情况下，RDB 仍然能够提供有关最大延迟的更多保证。
  - Redis AOF 通过像 MySQL 或 MongoDB 那样增量更新现有状态来工作，而 RDB 快照一次又一次地创建所有内容，从概念上讲，它更健壮。但是应该注意的是，每次 Redis 重写 AOF 时，都会从数据集中包含的实际数据开始从头开始重新创建 AOF，与始终附加 AOF 文件（或一个重写的读取旧的 AOF，而不是读取内存中的数据）相比，它对错误的抵抗力更强。

## 如何选择哪种持久化方式

- 通常，如果您想要某种与 PostgreSQL 可以提供的功能相当的数据安全性，则应同时使用两种持久性方法。
- 如果您非常关心数据，但是在灾难情况下仍然可以承受几分钟的数据丢失，则只需使用 RDB。
- 有很多用户单独使用 AOF，官方不建议这样做，因为不时拥有 RDB 快照对于进行数据库备份，加快重启速度以及 AOF 引擎中存在错误是一个好主意。

## 更多详细信息

### 快照

默认情况下，Redis 将数据集的快照保存在磁盘上的二进制文件`dump.rdb`中。如果数据集中至少有 M 个更改，可以将 Redis 配置为使其每 N 秒保存一次数据集，或者可以手动调用 SAVE 或者 BGSAVE 命令。

例子

```text
# 如果更改了至少1000个密钥，此配置将使Redis每60秒自动将数据集转储到磁盘
save 60 1000
```

---

**How it works**  
每当 Redis 需要将数据集转储到磁盘时，就会发生以下情况：

- Redis forks, 现在，我们有一个子进程和父进程。
- 子进程开始将将数据集写入临时 RDB 文件。
- 当子进程完成新的 RDB 文件写入后，它将替换旧的 RDB 文件。

此方法使 Redis 可以受益于 copy-on-write 语义。

### Append-only 文件

使用快照不是很耐用。如果运行 Redis 的计算机停止运行，电源线出现故障或意外使用 kill -9 杀死 Redis 实例，则写入 Redis 的最新数据会丢失。  
`append-only文件`是 Redis 的另一种完全持久的策略。可在配置文件中打开 AOF 配置。

    appendonly yes

#### 日志重写

随着执行写操作，AOF 越来越大。因此，Redis 支持在后台重建 AOF，而不会中断对客服端的服务。每当您发出 BGREWRITEAOF 时，Redis 都会编写最短的命令序列来重建内存中的当前数据集。如果您将 AOF 与 Redis 2.2 一起使用，则需要不时运行 BGREWRITEAOF。 Redis 2.4 能够自动触发日志重写

**How it works**

日志重写使用与快照相同的写时复制技巧：

- Redis forks，现在有一个父进程和一个子进程。
- 子开始在临时文件中写入新的 AOF。
- 父进程将所有新更改累积在内存缓冲区中（但同时它会将新更改写入旧的append-only文件中，因此，如果重写失败，我们是安全的）。
- 当子进程完成文件的重写后，父进程会收到一个信号，并在子进程生成的文件末尾附加内存中的缓冲区数据。
- 现在，Redis 原子地将旧文件重命名为新文件，并开始将新数据追加到新文件中。

#### append-only 文件的耐用性

可以配置 Redis 将磁盘上的数据同步多少次。有三个选项：

- appendfsync always：每次将新命令附加到 AOF 时均使用 fsync。非常非常慢，非常安全。
- appendfsync everysec：每秒 fsync。速度足够快(在 2.4 中可能与快照速度一样快)，如果发生灾难，可能会丢失 1s 的数据
- appendfsync no：永不 fsync，只需将数据交给操作系统即可。更快且更不安全。通常，Linux 使用此配置每 30 秒刷新一次数据。但这取决于内核的精确调整。

建议(默认)策略是每秒同步一次。它既快速又安全。Always 策略在实践中非常慢，但是它支持组提交，因此，如果有多个并行写入，Redis 将尝试执行单个 fsync 操作。

#### 如果 AOF 被截断怎么办\?

写入 AOF 文件时服务器可能崩溃，或者写入时存储 AOF 文件的卷已满。发生这种情况时，AOF 仍包含表示数据集给定时间点版本的一致数据（使用默认的 AOF fsync 策略，该数据可能已过期长达一秒钟），但 AOF 中的最后一条命令可能会被截断。Redis 的最新主要版本仍将能够加载 AOF，只需丢弃文件中最后一个格式不正确的命令即可。在这种情况下，服务器将发出如下日志：

```text
* Reading RDB preamble from AOF file...
* Reading the remaining AOF tail...
# !!! Warning: short read while loading the AOF file !!!
# !!! Truncating the AOF at offset 439 !!!
# AOF loaded anyway because aof-load-truncated is enabled
```

如果需要，您可以更改默认配置以强制 Redis 在这种情况下停止，但是无论文件中的最后一个命令格式是否正确，默认配置都是继续执行，以确保重新启动后的可用性。

旧版本的 Redis 可能无法恢复，并且可能需要执行以下步骤：

- 备份您的 AOF 文件。
- 使用 Redis 随附的 redis-check-aof 工具修复原始文件： \$ redis-check-aof --fix
- （可选）使用 diff -u 检查两个文件之间的区别。
- 用固定文件重新启动服务器。

#### 如果 AOF 损坏了怎么办\?

如果 AOF 文件不仅被截断，而且在中间被无效字节序列损坏，则情况会更加复杂。 Redis 将在启动时报错并中止：

```text
* Reading the remaining AOF tail...
# Bad file format reading the append only file: make a backup of your AOF file, then use ./redis-check-aof --fix <filename>
```

最好的办法是运行 redis-check-aof 实用程序，最初不带--fix 选项，然后理解问题，跳转到文件中的给定偏移量，并查看是否可以手动修复文件：

> AOF 使用与 Redis 协议相同的格式，并且手动修复非常简单。否则，可以让该实用程序为我们修复文件，但是在那种情况下，从无效部分到文件末尾的所有 AOF 部分都可能会被丢弃，如果损坏恰好是在文件的初始部分，则会导致大量数据丢失。

#### 如果当前正在使用 dump.rdb 快照如何切换到 AOF\?

在 Redis 2.0 和 Redis 2.2 中，执行此操作的过程有所不同：

**Redis >= 2.2**

- 备份最新的 dump.rdb 文件。
- 把这个备份转移到安全的地方。
- 发出以下两个命令:
  - redis-cli config set appendonly yes
  - redis-cli config set save ""
- 确保您的数据库包含与它所包含的键相同数量的键。
- 确保写入被正确地附加到 append only 文件。

第一个 CONFIG 命令启用“仅追加文件”。为此，Redis 将阻止生成初始 dump，然后打开文件进行写入，并开始附加所有下一个写入查询。

第二个 CONFIG 命令用于关闭快照持久化。如果您希望同时启用这两种持久性方法的话，这是可选的。

**IMPORTANT**：请记住编辑 redis.conf 以打开 AOF，否则，当重新启动服务器时，配置更改将丢失，并且服务器将使用旧配置重新启动。

---

**Redis 2.0**

- 备份最新的 dump.rdb 文件。
- 把这个备份转移到安全的地方。
- 停止对数据库的所有写操作!
- 发出 redis-cli BGREWRITEAOF。这将创建 append-only 文件。
- 当 Redis 完成生成 AOF dump 时停止服务器。
- 编辑 redis.conf 启用仅追加文件持久性。
- 重新启动服务器。
- 确保您的数据库包含与它所包含的键相同数量的键。
- 确保写入被正确地附加到仅追加文件。

#### AOF 与 RDB 持久化之间的相互作用

- Redis> = 2.4 可以确保避免在 RDB 快照操作正在进行时触发 AOF 重写，或者在 AOF 重写正在进行时允许 BGSAVE。这样可以防止两个 Redis 后台进程同时执行大量磁盘 I / O。
- 当进行快照时，用户使用 BGREWRITEAOF 显式请求日志重写操作时，服务器将以 OK 状态代码答复，告知用户已安排该操作，并且快照完成后将开始重写。
- 如果同时启用了 AOF 和 RDB 持久性，并且 Redis 重新启动，则`AOF文件将用于重建原始数据集`，因为它可以保证是最完整的。

#### 备份 Redis 数据

Redis 非常便于数据备份，因为您可以在数据库运行时复制 RDB 文件：RDB 一旦生成，就永远不会被修改，而在生成时，它使用一个临时名称，并且仅在新快照完成时才使用 rename(2)原子地重命名为其最终目的地。

这意味着在服务器运行时，复制 RDB 文件是完全安全的。这是建议：

- 在服务器中创建一个 cron 作业，在一个目录中创建 RDB 文件的每小时快照，在另一个目录中创建每日快照。
- 每次运行 cron 脚本时，请确保调用 find 命令以确保删除太旧的快照：例如，您可以保留最近 48 小时的每小时快照，以及保留一两个月的每日快照。确保使用数据和时间信息命名快照。
- 每天至少要确保一次将 RDB 快照传输到数据中心外部，或者至少传输到运行 Redis 实例的物理计算机外部。

如果您在仅启用 AOF 持久性的情况下运行 Redis 实例，您仍然可以复制 AOF 以便创建备份。该文件可能缺少最后一部分，但是 Redis 仍然可以加载它（请参阅前面有关 AOF 文件被截断的部分）。

#### 灾难恢复

Redis 的灾难恢复与备份基本相同，并且能够在许多不同的外部数据中心中传输这些备份。即使在某些灾难性事件影响 Redis 运行并生成其快照的主数据中心的情况下，也可以通过这种方式保护数据。

灾难恢复建议

- Amazon S3
- 通过 SCP 将快照传输到备份的 VPS
- 注意在完成传输时，验证文件的大小和 SHA1 摘要
- 如果由于某些原因无法传输新备份，则还需要某种独立的警报系统。

> **参考**  
> [Redis Persistence](https://redis.io/topics/persistence)
